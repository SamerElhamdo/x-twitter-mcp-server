#!/usr/bin/env python3
"""
Twitter MCP Server Runner - OAuth 2.0

ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù…Ø¹ Ø¯Ø¹Ù… OAuth 2.0
"""

import sys
import os
import argparse
import uvicorn

# Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù„Ù‰ Python path
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from src.x_twitter_mcp.config import get_settings
from src.x_twitter_mcp.database import db_manager

def main():
    """Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…"""
    parser = argparse.ArgumentParser(description="Twitter MCP Server - OAuth 2.0")
    parser.add_argument("--host", help="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø§Ø¯Ù… (Ø§ÙØªØ±Ø§Ø¶ÙŠ: 127.0.0.1)")
    parser.add_argument("--port", type=int, help="Ù…Ù†ÙØ° Ø§Ù„Ø®Ø§Ø¯Ù… (Ø§ÙØªØ±Ø§Ø¶ÙŠ: 8000)")
    parser.add_argument("--debug", action="store_true", help="ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØ·ÙˆÙŠØ±")
    parser.add_argument("--reload", action="store_true", help="Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ")
    
    args = parser.parse_args()
    
    # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    settings = get_settings()
    
    # ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ù…Ø±Ø±Ø©
    if args.host:
        settings.host = args.host
    if args.port:
        settings.port = args.port
    if args.debug:
        settings.debug = True
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    print("ğŸ—„ï¸  Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...")
    try:
        db_manager.create_tables()
        print("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­")
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {e}")
        sys.exit(1)
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª OAuth
    print("ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª OAuth 2.0...")
    if not settings.validate_oauth_config():
        print("âš ï¸  ØªØ­Ø°ÙŠØ±: TWITTER_CLIENT_ID ØºÙŠØ± Ù…Ø­Ø¯Ø¯")
        print("ğŸ’¡ ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ù„Ù .env Ø£Ùˆ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©")
        print("ğŸ“– Ø±Ø§Ø¬Ø¹ README.md Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯")
    else:
        print("âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª OAuth 2.0")
    
    # Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø§Ø¯Ù…
    print("\n" + "="*60)
    print("ğŸš€ Twitter MCP Server - OAuth 2.0")
    print("="*60)
    print(f"âœ… Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ http://{settings.host}:{settings.port}")
    print(f"ğŸŒ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©: http://{settings.host}:{settings.port}/")
    print(f"ğŸ“– ÙˆØ§Ø¬Ù‡Ø© API: http://{settings.host}:{settings.port}/docs")
    print(f"ğŸ” ØµÙØ­Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©: http://{settings.host}:{settings.port}/auth")
    print(f"ğŸ—„ï¸  Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {settings.database_url}")
    print(f"ğŸ”§ Ø§Ù„Ø¨ÙŠØ¦Ø©: {settings.environment}")
    print(f"ğŸ› ÙˆØ¶Ø¹ Ø§Ù„ØªØ·ÙˆÙŠØ±: {'Ù…ÙØ¹Ù„' if settings.debug else 'Ù…Ø¹Ø·Ù„'}")
    print("="*60)
    print("ğŸ’¡ Ø§Ø¶ØºØ· Ctrl+C Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø®Ø§Ø¯Ù…")
    print("="*60 + "\n")
    
    # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…
    try:
        uvicorn.run(
            "src.x_twitter_mcp.server:app",
            host=settings.host,
            port=settings.port,
            reload=args.reload or settings.debug,
            log_level=settings.get_log_level(),
            access_log=True
        )
    except KeyboardInterrupt:
        print("\nğŸ›‘ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø®Ø§Ø¯Ù… Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
    except Exception as e:
        print(f"\nâŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()
